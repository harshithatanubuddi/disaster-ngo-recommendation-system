<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Live Disaster Alerts – NGO Decision Support</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />

  <!-- Marker Cluster -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css"
  />
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css"
  />

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>

  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      font-size: 14px;
    }

    #map {
      height: 60vh;
    }

    .panel {
      padding: 12px;
      border-top: 2px solid #ddd;
    }

    .live {
      color: green;
      font-weight: bold;
    }

    .warn {
      color: red;
      font-weight: bold;
    }

    button {
      padding: 8px 12px;
      font-size: 14px;
      cursor: pointer;
      margin-right: 6px;
    }

    .table-wrapper {
      overflow-x: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      min-width: 600px;
    }

    th, td {
      padding: 6px;
      border: 1px solid #ccc;
      font-size: 13px;
      white-space: nowrap;
    }

    th {
      background: #f2f2f2;
    }

    @media (max-width: 768px) {
      #map {
        height: 50vh;
      }

      button {
        width: 100%;
        margin-bottom: 8px;
      }
    }
  </style>
</head>

<body>

<div id="map"></div>

<div class="panel">
  <h3>Live Alert Mode</h3>
  <button onclick="loadLiveAlerts()">Fetch Live Alerts</button>
  <button onclick="goToDemo()">Go to Demo Mode</button>
  <div id="status"></div>
  <div id="alerts"></div>
</div>

<div class="panel">
  <h3>
    Recommended NGOs (Distance-Based)
    <button
      style="margin-left:10px"
      onclick="window.open('https://ngodarpan.gov.in/#/search-ngo', '_blank')">
      Verify NGOs on DARPAN
    </button>
  </h3>
  <div class="table-wrapper">
    <table>
      <thead>
        <tr>
          <th>Rank</th>
          <th>NGO Name</th>
          <th>District</th>
          <th>Distance (km)</th>
          <th>Score</th>
          <th>Darpan ID</th>
        </tr>
      </thead>
      <tbody id="ngoTable"></tbody>
    </table>
  </div>
</div>

<script>
/* ================= API BASE ================= */

const API_BASE =
  location.hostname === "localhost" || location.hostname === "127.0.0.1"
    ? "http://127.0.0.1:8000"
    : "https://disaster-ngo-recommendation-system.onrender.com";

/* ================= MAP ================= */

const map = L.map("map", { preferCanvas: true })
  .setView([20.5, 78.9], 4);

map.doubleClickZoom.disable();

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  attribution: "© OpenStreetMap contributors"
}).addTo(map);

const ngoCluster = L.markerClusterGroup();
map.addLayer(ngoCluster);

let alertLayer = null;

/* ================= HELPERS ================= */

function severityColor(sev) {
  return {
    Extreme: "#8B0000",
    High: "#FF4500",
    Medium: "#FFA500",
    Low: "#FFD700"
  }[sev] || "#999";
}

function clearAll() {
  ngoCluster.clearLayers();
  if (alertLayer) {
    map.removeLayer(alertLayer);
    alertLayer = null;
  }
  document.getElementById("alerts").innerHTML = "";
  document.getElementById("ngoTable").innerHTML = "";
}

/* ================= LIVE ALERTS ================= */

function loadLiveAlerts() {
  clearAll();

  document.getElementById("status").innerHTML =
    `<p class="live">Fetching live India-relevant alerts…</p>`;

  fetch(`${API_BASE}/disasters/live`)
    .then(r => r.json())
    .then(data => {

      if (!data.features || !data.features.length) {
        document.getElementById("status").innerHTML =
          `<p class="warn">No active live alerts</p>`;
        return;
      }

      document.getElementById("status").innerHTML =
        `<p class="live">Live alerts loaded</p>`;

      data.features.forEach((f, idx) => {
        const p = f.properties;
        const [lon, lat] = f.geometry.coordinates;

        document.getElementById("alerts").innerHTML += `
          <hr>
          <b>Alert ${idx + 1}</b><br>
          ${p.title}<br>
          <b>Type:</b> ${p.disaster_type}<br>
          <b>Severity:</b> ${p.severity}
        `;

        alertLayer = L.circle([lat, lon], {
          radius: 50000,
          color: severityColor(p.severity),
          fillOpacity: 0.4
        }).addTo(map);

        map.setView([lat, lon], 6);

        fetch(`${API_BASE}/recommend/ngos/live`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ lat, lon })
        })
          .then(r => r.json())
          .then(renderNGOs);
      });
    })
    .catch(() => {
      document.getElementById("status").innerHTML =
        `<p class="warn">Error loading live alerts</p>`;
    });
}

/* ================= NGO RENDER ================= */

function renderNGOs(data) {
  const tbody = document.getElementById("ngoTable");
  tbody.innerHTML = "";
  ngoCluster.clearLayers();

  data.features.forEach((f, i) => {
    const p = f.properties;

    ngoCluster.addLayer(
      L.geoJSON(f, {
        pointToLayer: (_, latlng) =>
          L.marker(latlng).bindPopup(
            `<b>${p.name}</b><br>
             District: ${p.district}<br>
             Distance: ${p.distance_km} km<br>
             Score: ${p.score}<br>
             Darpan ID: ${p.darpan_id || "—"}`
          )
      })
    );

    tbody.innerHTML += `
      <tr>
        <td>${i + 1}</td>
        <td>${p.name}</td>
        <td>${p.district}</td>
        <td>${p.distance_km}</td>
        <td>${p.score}</td>
        <td>${p.darpan_id || "—"}</td>
      </tr>`;
  });
}

/* ================= NAV ================= */

function goToDemo() {
  window.location.href = "/index.html";
}
</script>

</body>
</html>
